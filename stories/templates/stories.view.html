{% extends "stories.base.html" %}
{% load markup %}
{% load storyviewfilters %}
{% block extranav %}
<div class="well sidebar-nav">
  <ul class="nav nav-list">
    <li class="nav-header">This story</li>
    <li><a href="#editprio" data-toggle="modal">Change priority</a></li>
    <li><a href="#editstory" data-toggle="modal">Modify story</a></li>
    <li class="disabled"><a href="#">Add task</a></li>
    <li class="disabled"><a href="#">Order tasks</a></li>
  </ul>
</div><!--/.well -->
{% endblock %}
{% block content %}
<div class="row-fluid">
  <div class="span2">
    <h3>Bug {{ story.id }}</h3>
  </div>
  <div class="span10">
    <a href=#editprio data-toggle="modal">
      <span class="badge{{ story.priority|priobadge }}">
      {{ story.get_priority_display }}</span></a><br>
    <h4>{{ story.title }}</h4>
  </div>
</div>
<hr>
<div class="row-fluid">
  <div class="span12">
    <table class="table table-condensed">
      <thead>
        <tr>
          <th>Task</th>
          <th>Project</th>
          <th>Series</th>
          <th>Assignee</th>
          <th>Status</th>
          <th>Milestone</th>
        </tr>
      </thead>
      <tbody>
{% for task in story.task_set.all %}
        <tr class="{{ task.status|taskcolor }}">
          <td>{{ task.title }}</td>
          <td>{{ task.project.title }}</td>
          <td>{{ task.series.name }}</td>
          <td>{{ task.assignee.username }}</td>
          <td>{{ task.get_status_display }}</td>
          <td>{{ task.milestone.name }}</td>
          <td>
              <a href="#edittask{{ task.id }}" class="btn btn-micro" data-toggle="modal"><i class="icon-edit"></i></a>
              <button class="btn btn-micro disabled" type="button"><i class="icon-remove"></i></button>
          </td>
        </tr>
{% endfor %}
      </tbody>
    </table>
  </div>
</div>
<div class="row-fluid">
  <div class="span12">
    <div class="well well-small">
      {{ story.description|markdown:"safe" }}
    </div>
    <p><i class="icon-tags"></i>
{% for tag in story.storytag_set.all %}
    <span class="label">{{ tag.name }}</span>
{% endfor %}
   </p>
  </div>
</div>
<div class="row-fluid">
  <table class="table table-striped">
    <tbody>
{% for comment in story.comment_set.all %}
     <tr><td colspan=2>
       <i class="icon-{{ comment.comment_type }}"></i>
       by {{ comment.author.username }} on {{ comment.posted_date }}:
     {% if comment.action %}<br>{{ comment.action }}{% endif %}
     </td></tr>
     <tr><td>{{ comment.content|markdown:"safe" }}</td></tr>
{% endfor %}
    </tbody>
  </table>
  <form method="POST" action="/story/{{ story.id }}/comment">
    {% csrf_token %}
    <textarea name="content" class="input-block-level" rows="3" placeholder="Add a comment"></textarea>
    <button class="btn btn-mini" type="submit">Add comment</button>
  </form>
</div>
<!-- Modify Story modal -->
<form method="POST" action="/story/{{story.id}}/edit">{% csrf_token %}
<div id="editstory" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="editStoryLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="editStoryLabel">Modify story</h3>
  </div>
  <div class="modal-body">
    <label>Title</label>
    <input class="input-block-level" name="title"
           type="text" value="{{ story.title }}">
    <label>Description <small>(can use Markdown)</small></label>
    <textarea class="input-block-level" name="description" rows="9">{{ story.description }}</textarea>
    <label>Tags</label>
    <div class="input-prepend">
    <span class="add-on"><i class="icon-tags"></i></span>
    <input class="input-block-level" name="tags" id="prependedInput" type="text"
     value="{% for tag in story.storytag_set.all %}{{ tag.name }} {% endfor %}">
    </span>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
    <input class="btn btn-primary" type="submit" value="Save changes">
  </div>
</div>
</form>
<!-- Set priority Modal -->
<form method="POST" action="/story/{{ story.id }}/priority">
<div id="editprio" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="editPriolLabel" aria-hidden="true">
  {% csrf_token %}
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="editPrioLabel">Change priority</h3>
  </div>
  <div class="modal-body">
    <label>Priority</label>
    <div class="btn-group" data-toggle="buttons-radio">
{% for code, prio in priorities %}
    <button type="button" data-value="{{code}}"
            class="prio btn btn-small{{code|priobutton}}{% if story.priority == code %} active{% endif %}">{{ prio }}</button>
{% endfor %}
    </div>
    <label class="after-buttongroup">Comment</label>
    <textarea class="input-block-level" rows="6" name="comment"
     placeholder="Add a comment"></textarea>
    <input type="hidden" id="priority" name="priority" value="{{ story.priority }}">
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
    <input class="btn btn-primary" type="submit" value="Save changes">
  </div>
</div>
</form>
<!-- Edittask Modals -->
{% for task in story.task_set.all %}
<form method="POST" action="/story/task/{{ task.id }}">
<div id="edittask{{ task.id }}" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="editTaskLabel" aria-hidden="true">
  {% csrf_token %}
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="editTaskLabel">Edit
    {{task.project.name}}/{{task.series.name}} task</h3>
  </div>
  <div class="modal-body">
    <label>Title <small>(optional)</small></label>
    <input type="text" name="title" value="{{ task.title }}">
    <label>Assignee</label>
    <div class="input-prepend">
      <span class="add-on"><i class="icon-user"></i></span>
      <input id="prependedInput" type="text" name="assignee"
             value="{{task.assignee.username}}">
    </div>
    <label>Milestone</label>
    <div class="btn-group" data-toggle="buttons-radio">
      <button type="button" data-value=""
              class="btn btn-small ms{{task.id}}
              {% if not task.milestone %}active{% endif %}">
              None</button>
    {% for milestone in milestones %}
      {% if milestone.series == task.series %}}
      <button type="button" data-value="{{milestone.id}}"
              class="btn btn-small
{% if task.milestone == milestone %}active{% endif %}
{% if milestone.active or task.milestone == milestone %}ms{{task.id}}{%endif%}
{% if not milestone.active %}btn-success
  {% if task.milestone != milestone %}disabled{%endif%}
{% endif %}"
{% if task.milestone != milestone and not milestone.active %}disabled="disabled"{%endif%}>
              {{ milestone.name }}</button>
      {% endif %}
    {% endfor %}
    </div>
    <label class="after-buttongroup">Status</label>
    <div class="btn-group" data-toggle="buttons-radio">
  {% for code, status in taskstatuses %}
    <button type="button" data-value="{{code}}"
            class="stat{{ task.id }} btn btn-small btn-{{code|taskcolor}}{% if task.status == code %} active{% endif %}">{{ status }}</button>
  {% endfor %}
    </div>
    <label class="after-buttongroup">Comment</label>
    <textarea class="input-block-level" rows="3"
     placeholder="Add a comment"></textarea>
    <input type="hidden" id="ms{{task.id}}" name="milestone" value="{{ task.milestone.id }}">
    <input type="hidden" id="status{{task.id}}" name="status" value="{{ task.status }}">
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
    <input class="btn btn-primary" type="submit" value="Save changes">
  </div>
</div>
</form>
{% endfor %}
{% endblock %}
{% block moarscript %}
$(".prio").click(function() {
    $("#priority").val($(this).data("value"));
});
{% for task in story.task_set.all %}
$(".stat{{task.id}}").click(function() {
    $("#status{{task.id}}").val($(this).data("value"));
});
$(".ms{{task.id}}").click(function() {
    $("#ms{{task.id}}").val($(this).data("value"));
});
{% endfor %}
{% endblock %}
